# Serial Servo Motor 
서보 모터(Servo Motor)는 특정 각도나 위치를 정밀하게 제어할 수 있는 모터로, 로봇 팔, 카메라 짐벌, RC 자동차 등 다양한 제어 시스템에 사용됩니다.  

기존의 일반 서보 모터는 **PWM(Pulse Width Modulation)** 신호를 이용해 제어되며, 각 채널마다 독립적인 제어선을 필요로 합니다.  

하지만 **Serial Servo Motor**는 이름 그대로 **직렬 통신(UART)** 을 통해 다수의 모터를 **한 개의 통신 라인**으로 제어할 수 있는 장점이 있습니다.  
예를 들어, LX-224와 같은 Serial Servo는 **ID 기반의 개별 제어**, **위치/속도/온도 읽기**, **전압 보호** 등의 고급 기능을 제공합니다.  

| 구분 | 일반 Servo Motor | Serial Servo Motor |
|:---:|:---|:---|
| 제어 방식 | PWM (1핀당 1채널) | UART 직렬 통신 (1라인으로 다수 제어) |
| 제어 범위 | 제한적 (보통 0~180도) | 넓음 (0~240도 이상) |
| 피드백 | 불가능 | 위치/전압/온도 피드백 가능 |
| ID 기반 제어 | 불가능 | 가능 |
| 동기 제어 | 어려움 | 다수 서보의 동기화 가능 |
| 사용 예시 | RC 카, 간단한 로봇 | 로봇 팔, 정밀 제어 시스템 |

![Serial Servo Motor ]() 

## Serial Servo Motor 패킷 
### Serial Servo Motor 패킷 구조 
| 구분 | 바이트열 | 설명 |
|:--|:--|:--|
| Header | `0x55 0x55` | 고정 2바이트 |
| ID | `0x01 ~ 0xFD` | 서보 고유 ID (`0xFE` = 브로드캐스트) |
| Length | `3 + 파라미터 개수` | `CMD + PARAMS + CHK`를 포함 |
| CMD | 명령 코드 | 수행할 동작 지정 |
| PARAMS | 가변 | 명령별 데이터 |
| CHK | 1바이트 | `(~(ID + LEN + CMD + sum(PARAMS))) & 0xFF` |

### 각도 및 시간 단위 
| 항목 | 범위 | 변환식 |
|:--|:--|:--|
| 각도(raw) | 0 ~ 1000 | 내부 단위 |
| 실제 각도(°) | 0° ~ 240° | `deg = raw * 240 / 1000` |
| 시간 | 0 ~ 30000 ms | 이동 시간(ms 단위) |

### 필수 명령 
| CMD | 코드(hex) | 기능 | 송신 파라미터 | 응답 데이터 | 설명 |
|:--|:--:|:--|:--|:--|:--|
| `CMD_MOVE_TIME_WRITE` | `0x01` | 목표 위치로 이동 | `Angle_L, Angle_H, Time_L, Time_H` | 없음/ACK | 각도와 시간 지정 |
| `CMD_POS_READ` | `0x1C` | 현재 위치 읽기 | 없음 | `Pos_L, Pos_H` | 실시간 위치 확인 |
| `CMD_LOAD_OR_UNLOAD_WRITE` | `0x1F` | 토크 ON/OFF | `1=ON / 0=OFF` | 없음/ACK | 서보 구동 전원 제어 |
| `CMD_ID_READ` | `0x0E` | 현재 ID 읽기 | 없음 | `ID` | 초기 통신 테스트용 |
| `CMD_ID_WRITE` | `0x0D` | ID 변경 | `NEW_ID` | 없음/ACK | 여러 서보 구분용 |
| `CMD_MODE_WRITE` | `0x1D` | 모드 설정 | `0=Servo, 1=Motor` | 없음/ACK | 각도/속도 모드 전환 |
| `CMD_TEMP_READ` | `0x1A` | 온도 읽기 | 없음 | `Temp` | °C 단위 |
| `CMD_VIN_READ` | `0x1B` | 입력 전압 읽기 | 없음 | `Vin_L, Vin_H` | mV 단위(기종에 따라 다름) |

## Serial Servo Motor 연결 구성 

| Pico Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| GP0 | TX | 데이터 송신 |
| GP1 | RX | 데이터 수신 |
| GP2 | DIR | 데이터 방향 제어 (송신/수신 전환) |
| 5V | VCC | 서보 전원 |
| GND | GND | 공통 접지 |

![serial servo connection](res/serial%20servo%20connection.png)

## Serial Servo Motor 제어 코드

```python
from machine import UART, Pin
import time

UART_ID = 0
PIN_TX  = 0
PIN_RX  = 1
PIN_DIR = 2
BAUD    = 115200
SERVO_ID = 1
TIMEOUT_MS = 50

dir_pin = Pin(PIN_DIR, Pin.OUT, value=0)
uart = UART(UART_ID, BAUD, tx=Pin(PIN_TX), rx=Pin(PIN_RX), bits=8, parity=None, stop=1, timeout=TIMEOUT_MS)

def _tx():
    dir_pin.value(1); time.sleep_us(3)
def _rx():
    dir_pin.value(0); time.sleep_us(3)

def _checksum(bsum):
    return (~bsum) & 0xFF

def _send(id_, cmd, params=b''):
    length = len(params) + 3
    total  = id_ + length + cmd + sum(params)
    chk    = _checksum(total)
    pkt = bytes([0x55,0x55, id_, length, cmd]) + params + bytes([chk])
    _tx(); uart.write(pkt); _rx()

def _read_status(expect_len=None, timeout_ms=TIMEOUT_MS):
    t0 = time.ticks_ms()
    while time.ticks_diff(time.ticks_ms(), t0) < timeout_ms:
        if uart.any():
            if uart.read(1) == b'\x55':
                if uart.read(1) == b'\x55':
                    break
    if uart.any() < 3:
        return None
    b = uart.read(3)
    if not b or len(b) < 3:
        return None
    sid, length, err = b[0], b[1], 0
    rem = length - 1
    rest = uart.read(rem)
    if not rest or len(rest) < rem:
        return None
    data, chk = rest[:-1], rest[-1]
    total = sid + length + sum(data)
    if _checksum(total) != chk:
        return None
    if expect_len is not None and len(data) != expect_len:
        pass
    return {"id": sid, "data": data}

CMD_MOVE_TIME_WRITE        = 1
CMD_MOVE_TIME_READ         = 2
CMD_MOVE_TIME_WAIT_WRITE   = 7
CMD_MOVE_START             = 11
CMD_MOVE_STOP              = 12
CMD_ID_WRITE               = 13
CMD_ID_READ                = 14
CMD_ANGLE_OFFSET_ADJUST    = 17
CMD_ANGLE_OFFSET_WRITE     = 18
CMD_ANGLE_LIMIT_WRITE      = 20
CMD_ANGLE_LIMIT_READ       = 21
CMD_VIN_LIMIT_WRITE        = 22
CMD_VIN_READ               = 27
CMD_TEMP_READ              = 26
CMD_POS_READ               = 28
CMD_MODE_WRITE             = 29
CMD_MODE_READ              = 30
CMD_LOAD_OR_UNLOAD_WRITE   = 31
CMD_LOAD_OR_UNLOAD_READ    = 32
CMD_LED_CTRL_WRITE         = 33
CMD_LED_CTRL_READ          = 34

def id_read(broadcast=True):
    _send(0xFE if broadcast else SERVO_ID, CMD_ID_READ)
    return _read_status()

def id_write(new_id):
    _send(SERVO_ID, CMD_ID_WRITE, bytes([new_id & 0xFF]))
    return _read_status()

def load(enable=True):
    _send(SERVO_ID, CMD_LOAD_OR_UNLOAD_WRITE, bytes([1 if enable else 0]))
    return _read_status()

def set_mode_servo():
    _send(SERVO_ID, CMD_MODE_WRITE, bytes([0, 0, 0, 0, 0]))
    return _read_status()

def move_time_write(angle_0_1000, time_ms):
    angle = max(0, min(1000, int(angle_0_1000)))
    t = max(0, min(30000, int(time_ms)))
    params = bytes([angle & 0xFF, (angle>>8)&0xFF, t & 0xFF, (t>>8) & 0xFF])
    _send(SERVO_ID, CMD_MOVE_TIME_WRITE, params)
    return _read_status()

def pos_read():
    _send(SERVO_ID, CMD_POS_READ)
    st = _read_status(expect_len=2)
    if not st: return None
    d = st["data"]
    return d[0] | (d[1]<<8)

def deg_to_lx(deg):
    deg = max(0.0, min(240.0, float(deg)))
    return int(round(deg * 1000.0 / 240.0))

def lx_to_deg(raw):
    raw = max(0, min(1000, int(raw)))
    return raw * 240.0 / 1000.0

def main():
    print("LX-224 demo start @115200")
    st = id_read(broadcast=True)
    if st:
        print("ID_READ(resp):", st)

    load(True)
    set_mode_servo()
    seq_deg = [40, 120, 200, 120]
    for d in seq_deg:
        a = deg_to_lx(d)
        print("-> move", d, "deg (", a, ") in 800ms")
        move_time_write(a, 800)

        t0 = time.ticks_ms()
        while time.ticks_diff(time.ticks_ms(), t0) < 1500:
            p = pos_read()
            if p is not None:
                now = lx_to_deg(p)
                if abs(now - d) < 2.0:
                    break
            time.sleep_ms(40)
        time.sleep_ms(200)

    load(False)
    print("Done.")

if __name__ == "__main__":
    _rx()
    main()

```

<details> 
<summary>심화 학습</summary> 
##