# Magnetic Rotary Encoder 
Magnetic Rotary Encoder(마그네틱 로터리 엔코더) 는 자석의 회전 각도를 감지하여
이를 디지털 신호로 변환해주는 센서입니다.

## Magnetic Rotary Encoder 개요 
일반적인 광학식 엔코더가 빛을 이용해 회전을 감지하는 것과 달리,
마그네틱 엔코더는 자기장(magnetic field) 의 방향을 감지하여 각도를 계산하기 때문에,
먼지나 기름, 습기 등 외부 환경에 강한 장점이 있습니다.

| 항목 | 설명 |
|---|---|
|인터페이스 | I2C (0x36) |
| 해상도 | 12-bit (0 ~ 4095 step → 0~360°) |
| 전원 전압 | 3.3V ~ 5V |
|기능 | 각도 측정, 자기장 상태 감지, 자동 Gain 조정 |
|장점 | 비접촉식, 고정밀, 내구성 우수, 저소음 |

## Magnetic Rotary Encoder 연결 구성 
| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP0 | SDA | I2C 데이터 |
| GP1 | SCL | I2C 클록 |

![Magnetic Connection](res/rotary%20connection.png)

## Magnetic Rotary Encoder 제어 코드
다음은 센서의 각도 데이터를 읽고, 현재 각도, 회전 누적 각도, 회전 속도를 출력하는 기본 예제입니다.

```python
from machine import I2C, Pin
import time, math

class AS5600:
    I2C_ADDR = 0x36

    REG_RAW_ANG_H = 0x0C
    REG_RAW_ANG_L = 0x0D
    REG_STATUS    = 0x0B
    REG_AGC       = 0x1A
    REG_MAG_H     = 0x1B
    REG_MAG_L     = 0x1C

    def __init__(self, i2c: I2C):
        self.i2c = i2c
        self.last_raw = None
        self.turns = 0
        self.zero = 0

    def _r8(self, reg):
        return self.i2c.readfrom_mem(self.I2C_ADDR, reg, 1)[0]

    def _r12(self, reg_h, reg_l):
        h = self._r8(reg_h) & 0x0F
        l = self._r8(reg_l)
        return (h << 8) | l  # 0~4095

    def raw_angle(self):
        return self._r12(self.REG_RAW_ANG_H, self.REG_RAW_ANG_L)

    def angle_deg(self):
        return self.raw_angle() * (360.0 / 4096.0)

    def set_zero(self):
        self.zero = self.raw_angle()
        self.turns = 0
        self.last_raw = self.zero

    def angle_zeroed(self):
        val = (self.raw_angle() - self.zero) & 0x0FFF
        return val * (360.0 / 4096.0)

    def multi_turn(self):
        now = self.raw_angle()
        if self.last_raw is None:
            self.last_raw = now
        delta = now - self.last_raw
        if delta > 2048: delta -= 4096
        elif delta < -2048: delta += 4096
        self.turns += delta
        self.last_raw = now
        return self.turns * (360.0 / 4096.0)

def main():
    i2c = I2C(0, sda=Pin(0), scl=Pin(1), freq=400000)
    enc = AS5600(i2c)   
    enc.set_zero()
    print("Rotate the magnet... (Ctrl+C to stop)\n")

    while True:
        try:
            deg_now = enc.angle_deg()
            deg_zeroed = enc.angle_zeroed()
            deg_multi = enc.multi_turn()
            print(f"Raw={deg_now:7.2f}°, Zeroed={deg_zeroed:7.2f}°, MultiTurn={deg_multi:8.2f}°")
            time.sleep(0.1)
        except KeyboardInterrupt:
            print("Stop.")
            break

if __name__ == "__main__":
    main()
```

> - raw_angle()는 0~4095 범위의 원시 각도 데이터를 읽습니다.
> - angle_deg()는 원시 각도를 도(°) 단위로 변환합니다.
> - set_zero()는 현재 위치를 기준으로 0°로 설정합니다.
> - angle_zeroed()는 소프트웨어 영점이 적용된 각도 값을 반환합니다.
> - multi_turn()는 회전이 여러 바퀴 진행될 때 누적 각도를 추적합니다.

## 엔코더 회전에 따른 서보모터 제어 
엔코더의 회전 각도에 따라 서보모터의 방향을 제어하는 예제입니다. 
AS5600은 0~4095 (12비트) 범위의 각도 데이터를 출력하므로, 이를 다음 식으로 비례 변환(linear mapping) 하여 서보모터 각도로 매핑합니다.

- servo_angle = (encoder_angle / 360) * 180

즉, **엔코더가 한 바퀴(360°)를 회전하면 서보모터는 반 바퀴(180°)** 만큼 움직이게 됩니다.

```python
from machine import Pin, PWM, I2C
import time

class AS5600:
    I2C_ADDR = 0x36

    REG_RAW_ANG_H = 0x0C
    REG_RAW_ANG_L = 0x0D
    REG_STATUS    = 0x0B
    REG_AGC       = 0x1A
    REG_MAG_H     = 0x1B
    REG_MAG_L     = 0x1C

    def __init__(self, i2c: I2C):
        self.i2c = i2c
        self.last_raw = None
        self.turns = 0
        self.zero = 0

    def _r8(self, reg):
        return self.i2c.readfrom_mem(self.I2C_ADDR, reg, 1)[0]

    def _r12(self, reg_h, reg_l):
        h = self._r8(reg_h) & 0x0F
        l = self._r8(reg_l)
        return (h << 8) | l  # 0~4095

    def raw_angle(self):
        return self._r12(self.REG_RAW_ANG_H, self.REG_RAW_ANG_L)

    def angle_deg(self):
        return self.raw_angle() * (360.0 / 4096.0)

    def set_zero(self):
        self.zero = self.raw_angle()
        self.turns = 0
        self.last_raw = self.zero

    def angle_zeroed(self):
        val = (self.raw_angle() - self.zero) & 0x0FFF
        return val * (360.0 / 4096.0)

    def multi_turn(self):
        now = self.raw_angle()
        if self.last_raw is None:
            self.last_raw = now
        delta = now - self.last_raw
        if delta > 2048: delta -= 4096
        elif delta < -2048: delta += 4096
        self.turns += delta
        self.last_raw = now
        return self.turns * (360.0 / 4096.0)

servo = PWM(Pin(15))
servo.freq(50)

i2c = I2C(0, sda=Pin(0), scl=Pin(1))
enc = AS5600(i2c)
enc.set_zero()

def set_servo(angle):
    duty = int(1000 + (angle / 180) * 1000) 
    servo.duty_u16(int(duty * 65.535))

while True:
    ang = enc.angle_zeroed()
    servo_ang = min(180, max(0, ang))
    set_servo(servo_ang)
    print(f"Encoder={ang:.1f}° → Servo={servo_ang:.1f}°")
    time.sleep(0.05)
```

> - AS5600.angle_zeroed()	엔코더가 회전한 실제 각도를 0~360° 범위로 반환합니다.
> - servo.duty_u16()	PWM 듀티비를 설정하여 서보 각도를 제어합니다.
> - ang / 2	엔코더의 0~360° 값을 0~180°로 비례 변환합니다.