# Light Sensor 

![Light Sensor]()

조도 센서(Light Sensor)는 주변의 밝기를 측정하여 **빛의 세기를 수치화(lux 단위)**하는 센서입니다.  
대표적인 I2C 기반 조도 센서인 **BH1750**은 고정밀 디지털 출력 기능을 가지고 있으며, 아날로그-디지털 변환(ADC) 과정이 내부적으로 처리되어 **MCU에서는 단순한 I2C 통신만으로 조도 값을 바로 읽을 수 있는 장점**이 있습니다.  

BH1750은 다음과 같은 특징을 가집니다.  

- I2C 통신 방식 (주소 기본값: `0x23`)  
- 측정 단위: lux (조도 단위)  
- 고해상도(High Resolution) / 저해상도(Low Resolution) 모드 지원  
- 소비 전류가 매우 낮고, 빠른 측정 속도를 가짐  
- 자동 감도 조정 기능 (MTreg 설정 가능)  

## Light Sensor 연결 구성 
BH1750 센서는 **Raspberry Pi Pico**나 **RP2040 보드**에서 `I2C`를 통해 쉽게 연결할 수 있습니다.  

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP0 | SDA | I2C 데이터 |
| GP1 | SCL | I2C 클록 |

![Light Connection](res/light%20connection.png)

## Light Sensor 제어 코드 

```python
from machine import I2C, Pin
import time

class Light:
    POWER_DOWN  = 0x00
    POWER_ON    = 0x01
    RESET       = 0x07

    CONT_HIRES_1   = 0x10
    CONT_HIRES_2   = 0x11
    CONT_LORES     = 0x13
    ONESHOT_HIRES_1= 0x20
    ONESHOT_HIRES_2= 0x21
    ONESHOT_LORES  = 0x23

    def __init__(self, i2c: I2C, addr=None, mtreg=69, mode=CONT_HIRES_1):
        self.i2c = i2c
        self.addr = 0x23
        self.mtreg = None
        self.mode = None

        self._write_cmd(self.POWER_ON)
        self._write_cmd(self.RESET)

        self.set_mtreg(mtreg)
        self.set_mode(mode)

    def _write_cmd(self, cmd):
        self.i2c.writeto(self.addr, bytes([cmd]))

    def set_mode(self, mode):
        self._write_cmd(mode)
        self.mode = mode

    def set_mtreg(self, mtreg: int):
        if mtreg < 31 or mtreg > 254:
            raise ValueError("mtreg must be in [31, 254]")
        self._write_cmd(self.POWER_ON)
        msb = 0x40 | (mtreg >> 5)
        lsb = 0x60 | (mtreg & 0x1F)
        self._write_cmd(msb)
        self._write_cmd(lsb)
        self.mtreg = mtreg
        if self.mode is not None:
            self._write_cmd(self.mode)

    def _integration_delay_ms(self):
        base_hi = 180
        base_lo = 30
        scale = (self.mtreg or 69) / 69.0
        if self.mode in (self.CONT_HIRES_1, self.CONT_HIRES_2, self.ONESHOT_HIRES_1, self.ONESHOT_HIRES_2):
            return int(base_hi * scale)
        else:
            return int(base_lo * scale)

    def read_raw(self):
        if self.mode in (self.ONESHOT_HIRES_1, self.ONESHOT_HIRES_2, self.ONESHOT_LORES):
            time.sleep_ms(self._integration_delay_ms())
        else:
            time.sleep_ms(10)

        data = self.i2c.readfrom(self.addr, 2)
        return (data[0] << 8) | data[1]

    def read_lux(self):
        raw = self.read_raw()
        if raw == 0xFFFF or raw == 0:
            return None
        lux = (raw / 1.2) * (69.0 / (self.mtreg or 69))
        return lux

def main():
    i2c = I2C(0, sda=Pin(0), scl=Pin(1), freq=100_000)
    sensor = Light(i2c, addr=None, mtreg=69, mode=Light.CONT_HIRES_1)

    while True:
        try:
            lux = sensor.read_lux()
            if lux is None:
                print("측정 대기/포화: 재시도중...")
            else:
                print("조도(lux): {:.2f}".format(lux))
            time.sleep(1.0)
        except KeyboardInterrupt:
            print("\nStop.")
            break
        except OSError as e:
            print("I2C 오류:", e, " -> 전원/배선 점검 및 센서 재기동")
            try:
                sensor._write_cmd(Light.POWER_ON)
                sensor._write_cmd(Light.RESET)
                if sensor.mtreg: sensor.set_mtreg(sensor.mtreg)
                if sensor.mode:  sensor.set_mode(sensor.mode)
            except Exception as _:
                pass
            time.sleep(0.5)

if __name__ == "__main__":
    main()
```






