# Ultrasonic Sensor 
초음파 센서는 **소리의 반사 시간을 이용하여 거리**를 측정하는 센서입니다.  
사람이 들을 수 없는 고주파(약 40kHz)의 초음파를 송출하고, 물체에 부딪혀 되돌아오는 신호를 감지하여 **왕복 시간(Time of Flight)** 으로 거리를 계산합니다.

이 센서는 로봇의 장애물 회피, 자동문, 거리 측정기, 스마트 주차장 등 다양한 분야에서 활용되고 있습니다.

## 초음파 거리 측정의 원리 
초음파 센서에서 초음파가 물체에 반사되어 돌아오는 시간을 측정하면, 이 시간을 이용하여 거리(㎝)를 계산할 수 있습니다.

## Ultrasonic Sensor 연결 구성 
이번 예제에서는 **Ultrasonic** 모듈을 이용합니다.  
이 모듈은 4개의 핀으로 구성되어 있으며, **전원(VCC/GND)** 과 **제어 핀(TRIG/ECHO)** 을 통해 제어됩니다.

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP14 | TRIG | 초음파 송신 |
| GP15 | ECHO | 초음파 반시 신호 수신 |

![ultrasonic connection](res/ultrasonic%20connection.png)

## Ultrasonic Sensor 제어 코드 

```python
from machine import Pin
import time

class Ultrasonic:
    def __init__(self, trig_pin, echo_pin):
        self.trig = Pin(trig_pin, Pin.OUT)
        self.echo = Pin(echo_pin, Pin.IN)

    def distance_cm(self):
        self.trig.value(0)
        time.sleep_us(2)
        self.trig.value(1)
        time.sleep_us(10)
        self.trig.value(0)

        start = time.ticks_us()
        while self.echo.value() == 0:
            if time.ticks_diff(time.ticks_us(), start) > 30000:
                return -1
        t1 = time.ticks_us()
        while self.echo.value() == 1:
            if time.ticks_diff(time.ticks_us(), t1) > 30000:
                return -1
        t2 = time.ticks_us()
        duration = time.ticks_diff(t2, t1)
        return (duration * 0.0343) / 2

def main():
    ultra = Ultrasonic(trig_pin=14, echo_pin=15)

    while True:
        try:
            dist = ultra.distance_cm()
            print("Distance: {:.2f} cm".format(dist))
            time.sleep_ms(300)
        except OSError as e:
            print("Error:", e)
            time.sleep_ms(300)
        except KeyboardInterrupt:
            print("\nStopped.")
            break

if __name__ == "__main__":
    main()
```

<details>
<summary>심화 학습</summary>

## 측정값 안정화를 위한 기법 
초음파 센서를 초당 여러 번 읽다 보면, 공기 중 소음이나 표면 재질, 반사각 등으로 인해 값이 들쑥날쑥할 수 있습니다.

이를 보정하기 위한 간단한 방법이 바로 “이동 평균(Sliding Average)” 입니다.
여러 번 측정한 값을 최근 N회 평균으로 부드럽게 만드는 방식입니다.

```python
from machine import Pin
import time

class Ultrasonic:
    def __init__(self, trig_pin, echo_pin):
        self.trig = Pin(trig_pin, Pin.OUT)
        self.echo = Pin(echo_pin, Pin.IN)

    def distance_cm(self):
        self.trig.value(0)
        time.sleep_us(2)
        self.trig.value(1)
        time.sleep_us(10)
        self.trig.value(0)

        start = time.ticks_us()
        while self.echo.value() == 0:
            if time.ticks_diff(time.ticks_us(), start) > 30000:
                return -1
        t1 = time.ticks_us()
        while self.echo.value() == 1:
            if time.ticks_diff(time.ticks_us(), t1) > 30000:
                return -1
        t2 = time.ticks_us()
        duration = time.ticks_diff(t2, t1)
        return (duration * 0.0343) / 2

def smooth_measure(sensor, samples=5):
    readings = []
    for _ in range(samples):
        d = sensor.distance_cm()
        if d > 0:
            readings.append(d)
        time.sleep_ms(100)
    if not readings:
        return -1

    return sum(readings) / len(readings)

def main():
    sensor = Ultrasonic(14, 15)
    while True:
        avg_dist = smooth_measure(sensor, samples=5)
        if avg_dist > 0:
            print("Smoothed Distance: {:.2f} cm".format(avg_dist))
        else:
            print("No valid data.")
        time.sleep(0.5)

if __name__ == "__main__":
    main()
```

</details>