# Joystick 
조이스틱(Joystick)은 사용자의 입력 방향과 세기를 아날로그 전압 변화로 표현하는 장치입니다.
내부에는 두 개의 **가변저항(Potentiometer)** 이 직교(90°) 방향으로 배치되어 있으며, 조이스틱 스틱을 움직이면 저항값이 변하게 됩니다.

각 축은 중앙인 경우 출력 전압이 입력전압의 중앙(TiCLE 의 경우 입력이 5V, 따라서 중앙은 2.5V)이 됩니다. 스틱을 왼쪽 혹은 아래로 이동할때 축에 전압이 낮아지고 반대의 경우에 높아지는 형태입니다. 이 전압을 ADC로 읽어 현재 조이스틱의 변위 정도를 확인할 수 있습니다. 

## Joystick 연결 구성 

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP26 | JV | Joystick Y축 입력 |
| GP27 | JH | Joystick X축 입력 |
| GP16 | JS | Joystick 스위치 입력 |

![Joystick Connection](res/joystick%20connection.png)

## Joystick 상태 읽기
다음 예제는 가장 기본적인 형태로, 조이스틱의 X축과 Y축의 아날로그 값을 그대로 읽어서 출력하는 코드입니다. 또한, 스위치(Push Switch)가 눌렸는지도 함께 확인할 수 있습니다.

```python
from machine import ADC, Pin
import utime

PIN_JOY_H = 26
PIN_JOY_V = 27
PIN_JOY_SW = 16

def main():
    adc_h = ADC(PIN_JOY_H)
    adc_v = ADC(PIN_JOY_V)
    joy_sw = Pin(PIN_JOY_SW, Pin.IN, Pin.PULL_UP)

    try:
        while True:
            h_raw = adc_h.read_u16()
            v_raw = adc_v.read_u16()
            print(f"H:{h_raw:5d}  V:{v_raw:5d}  |  JOY_SW:{joy_sw.value()}")
            utime.sleep_ms(100)
    except KeyboardInterrupt:
        print("Bye.")

if __name__ == "__main__":
    main()
```

아날로그 입력에는 미세한 노이즈가 섞이기 때문에 조금더 안정적인 값을 확인하기 위해서는 필터를 적용하는것이 좋습니다. 필터의 종류는 아주 다양한 필터가 존재하며, 여기서는 가장 단순하게 적용할 수 있는 평균 필터를 적용해 보겠습니다. 

```python
from machine import ADC, Pin
import utime

PIN_JOY_H = 26
PIN_JOY_V = 27
PIN_JOY_SW = 16
SAMPLE_N = 4

adc_h = ADC(PIN_JOY_H)
adc_v = ADC(PIN_JOY_V)
joy_sw = Pin(PIN_JOY_SW, Pin.IN, Pin.PULL_UP)

def read_adc_avg(adc: ADC, n=SAMPLE_N) -> int:
    s = 0
    for _ in range(n):
        s += adc.read_u16()
    return s // n

def main():
    try:
        while True:
            h_raw = read_adc_avg(adc_h)
            v_raw = read_adc_avg(adc_v)
            print(f"H:{h_raw:5d}  V:{v_raw:5d}  |  JOY_SW:{joy_sw.value()}")
            utime.sleep_ms(100)
    except KeyboardInterrupt:
        print("Bye.")

if __name__ == "__main__":
    main()
```

아날로그 값은 ADC의 해상도에 따라서 0 ~ 1024, 0 ~ 65535 와 같이 정해진 범위의 값을 출력합니다. 이를 단순히 값을 출력하는 형태가 아니라, 중앙을 기준으로 -100% ~ +100% 로 변환하여 Joystick 움직임 정도를 출력해보도록 하겠습니다. 

```python
from machine import ADC
import utime

PIN_JOY_H = 26
PIN_JOY_V = 27

adc_h = ADC(PIN_JOY_H)
adc_v = ADC(PIN_JOY_V)

SAMPLE_N = 8
PRINT_MS = 100
INVERT_H = False
INVERT_V = False
DEADZONE_P = 0.0

MIDPOINT = 32768.0
SPAN     = 32768.0

def read_adc_avg(adc: ADC, n=SAMPLE_N) -> int:
    s = 0
    for _ in range(n):
        s += adc.read_u16()
    return s // n

def clamp(v, lo, hi):
    return lo if v < lo else (hi if v > hi else v)

def to_percent_centered(raw: int, invert: bool=False) -> float:
    pct = ((raw - MIDPOINT) / SPAN) * 100.0
    if invert:
        pct = -pct
    return clamp(pct, -100.0, 100.0)

def apply_deadzone(pct: float, dz: float) -> float:
    if dz <= 0.0: 
        return pct
    return 0.0 if abs(pct) < dz else pct

def bar_pm100(pct: float, width: int = 20) -> str:
    pct = clamp(pct, -100.0, 100.0)
    half = width // 2
    pos = int(round((pct / 100.0) * half))
    if pos > 0:
        return "-"*half + "|" + "#"*pos + " "*(half-pos)
    elif pos < 0:
        return "-"*(half+pos) + "#"*(-pos) + "|" + "-"*half
    else:
        return "-"*half + "|" + "-"*half

def main():
    print("Analog joystick monitor (center=0%, range -100..+100). Ctrl+C to stop.")
    try:
        while True:
            h_raw = read_adc_avg(adc_h)
            v_raw = read_adc_avg(adc_v)

            h_pct = to_percent_centered(h_raw, INVERT_H)
            v_pct = to_percent_centered(v_raw, INVERT_V)

            h_pct = apply_deadzone(h_pct, DEADZONE_P)
            v_pct = apply_deadzone(v_pct, DEADZONE_P)

            print(f"H:{h_pct:+6.2f}% {bar_pm100(h_pct)} | V:{v_pct:+6.2f}% {bar_pm100(v_pct)}")
            utime.sleep_ms(PRINT_MS)
    except KeyboardInterrupt:
        print("Bye.")

if __name__ == "__main__":
    main()
```