# Dust Sensor  
PM2008M은 미세먼지(PM1.0, PM2.5, PM10)를 측정하기 위한 **Laser Scattering 방식의 센서**입니다.  
센서 내부에는 **레이저 다이오드**, **포토다이오드**, **공기 유입 팬**, 그리고 **MCU**가 내장되어 있으며,  
외부 마이크로컨트롤러(MCU)는 **I²C** 또는 **UART** 인터페이스를 통해 측정된 데이터를 읽을 수 있습니다.  

이번 실습에서는 **I²C 방식**으로 연결하여 데이터를 읽는 예제를 다룹니다.  


## Dust Sensor 연결 구성 

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP0 | SDA | I2C 데이터 |
| GP1 | SCL | I2C 클록 |

![Dust Connection](res/dust%20connection.png)

## Dust Sensor 제어 코드 

```python
from machine import I2C, Pin
import time

class Dust:
    ADDR = 0x28
    FRAME_LEN = 32

    def __init__(self, i2c: I2C):
        self.i2c = i2c

    @staticmethod
    def _xor_checksum(b):
        cs = 0
        for x in b[:31]:
            cs ^= x
        return cs == b[31]

    def read_frame(self):
        try:
            buf = self.i2c.readfrom(self.ADDR, self.FRAME_LEN)
        except OSError:
            return None

        if len(buf) != 32 or buf[0] != 0x16 or buf[1] != 0x20:
            return None
        if not self._xor_checksum(buf):
            return None

        status = buf[2]
        mode = (buf[3] << 8) | buf[4]
        coef_raw = (buf[5] << 8) | buf[6]
        coef = coef_raw / 100.0

        pm1_grimm = (buf[7]  << 8) | buf[8]
        pm25_grimm = (buf[9]  << 8) | buf[10]
        pm10_grimm = (buf[11] << 8) | buf[12]

        pm1_tsi = (buf[13] << 8) | buf[14]
        pm25_tsi = (buf[15] << 8) | buf[16]
        pm10_tsi = (buf[17] << 8) | buf[18]

        n_03 = (buf[19] << 8) | buf[20]
        n_05 = (buf[21] << 8) | buf[22]
        n_10 = (buf[23] << 8) | buf[24]
        n_25 = (buf[25] << 8) | buf[26]
        n_50 = (buf[27] << 8) | buf[28]
        n_100 = (buf[29] << 8) | buf[30]

        return {
            "status": status,
            "mode": mode,
            "coef": coef,
            "grimm": {"pm1": pm1_grimm, "pm25": pm25_grimm, "pm10": pm10_grimm},
            "tsi":   {"pm1": pm1_tsi,   "pm25": pm25_tsi,   "pm10": pm10_tsi},
            "counts":{">0.3": n_03, ">0.5": n_05, ">1.0": n_10, ">2.5": n_25, ">5.0": n_50, ">10": n_100}
        }

def main():
    i2c = I2C(0, sda=Pin(0), scl=Pin(1), freq=100_000)
    pm = Dust(i2c)

    while True:
        fr = pm.read_frame()
        if fr is None:
            print("Frame Error")
        else:
            st = fr["status"]
            st_txt = {1:"Close", 2:"Measuring", 7:"Alarm", 0x80:"Stable"}.get(st, f"0x{st:02X}")
            print(f"[Status={st_txt}, Mode={fr['mode']}, Coef={fr['coef']:.2f}] "
                  f"GRIMM PM1/2.5/10={fr['grimm']['pm1']}/{fr['grimm']['pm25']}/{fr['grimm']['pm10']} µg/m³ | "
                  f"TSI PM1/2.5/10={fr['tsi']['pm1']}/{fr['tsi']['pm25']}/{fr['tsi']['pm10']} µg/m³")
        time.sleep(1)

if __name__ == "__main__":
    main()
```

<details> 
<summary>심화 학습</summary>

## TSI 와 Grimm

PM2008M은 소형 저가형 센서로, 실내 환경 모니터링에는 충분히 유용하지만
정밀 연구용 분석에는 TSI, Grimm과 같은 고성능 장비가 사용됩니다.

이 장비들은 국제 표준(ISO 21501)에 따라 입자의 개수 및 크기를 정확히 측정할 수 있으며,
보정 알고리즘과 유량 제어(Flow Control) 기능이 내장되어 있습니다.

|구분|PM2008M|TSI DustTrak|Grimm EDM|
|---|---|---|---|
|원리|Laser Scattering|Laser + Flow Control|Optical Counter|
|입자 크기|0.3~10 μm|0.1~15 μm|0.25~32 μm|
|출력|PM1.0, PM2.5, PM10|PM1, PM2.5, PM10|입자 개수 및 질량|
|정확도|±15~30%|±5% 이내|±3% 이내|

PM2008M은 온도, 습도, 공기 흐름의 영향을 많이 받습니다.
따라서 실험 환경에 따른 보정 알고리즘을 직접 설계해보는 것이 좋은 심화 과제입니다.

</details>