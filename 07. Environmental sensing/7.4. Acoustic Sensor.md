# Acoustic Sensor  
Acoustic Sensor는 **소리(음향)** 를 감지하고 이를 전기적인 신호로 변환하여, **주변의 소음 수준**을 측정할 수 있는 센서입니다.  
이 센서는 주변의 소리 압력(음압)을 **dB(데시벨)** 단위로 측정하며, 보통 **A-가중치(dBA)** 라는 인간의 청각 특성에 맞춘 단위를 사용합니다.  

예를 들어,  
- 조용한 도서관의 소음은 약 **40 dBA**,  
- 일반 대화는 약 **60 dBA**,  
- 교통량이 많은 도로는 약 **80~90 dBA**,  
- 락 콘서트 현장은 약 **110 dBA** 수준입니다.  

소리의 세기는 **로그(logarithm)** 함수를 이용해 계산되며, 소리의 에너지가 10배 증가하면 약 **10 dB** 커진 것으로 표현됩니다.  

즉, 50 dB → 60 dB은 단순히 10이 아닌, **소리 에너지가 10배 증가한 것**을 의미합니다.  

![Acoustic Sensor]()  

### 소리의 물리적 원리  
소리는 공기 분자가 진동하며 퍼져나가는 **압력의 변화**입니다.  
이때 마이크로폰 센서는 이러한 압력 변화를 전기 신호로 바꾸어 줍니다.  

### 마이크의 종류
- **콘덴서 마이크 (Condenser Mic)** : 정전용량의 변화를 이용  
- **다이나믹 마이크 (Dynamic Mic)** : 전자기 유도 원리 이용  
- **MEMS 마이크 (Micro-Electro-Mechanical System)** : 미세한 기계 구조로 구성되어 반도체 칩 위에서 제작됨  

교육용으로 많이 사용하는 **ICS-43434** 센서는 MEMS 방식의 디지털 마이크로,  
내부에서 **아날로그 신호를 디지털로 변환(ADC)** 한 후 **I²S(Inter-IC Sound)** 인터페이스로 데이터를 전송합니다.  

이 센서의 출력값은 내부적으로 **음압 수준(SPL, Sound Pressure Level)** 을 계산하여 디지털 값으로 제공합니다.  

## Acoustic Sensor 연결 구성 

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP4 | SDA | I2C 데이터 |
| GP5 | SCL | I2C 클록 |

![Acoustic Connection]()

## Acoustic Sensor Register 
Acoustic Sensor 는 0x28 의 I2C 주소를 가지고 있으며 다음 레지스터에서 값을 읽을 수 있습니다. 

| 주소(HEX) | 명칭 | 크기(Byte) | 읽기/쓰기 | 설명 |
|:---:|:---:|:---:|:---:|:---|
| **0x00** | WHO_AM_I | 1 | R | 센서 ID 확인용 레지스터 (예: 0xA1) |
| **0x01** | STATUS | 1 | R | 데이터 유효 상태 비트 (bit0: Data Ready) |
| **0x30** | SPL_L | 1 | R | 음압 레벨(SPL)의 하위 바이트 (0.1 dBA 단위) |
| **0x31** | SPL_H | 1 | R | 음압 레벨(SPL)의 상위 바이트 |

## Acoustic Sensor 제어 코드 

```python
from machine import I2C,Pin
from utime import sleep

i2c0 = I2C(0, sda=Pin(4),scl=Pin(5), freq=100000)

while True:
    try:
        data_l = i2c0.readfrom_mem(0x28,0x30,1)
        data_h = i2c0.readfrom_mem(0x28,0x31,1)
        value = (int.from_bytes(data_h)<<8 | int.from_bytes(data_l))*0.1
        print(value)
        sleep(0.1)
    except:
        pass 
```

## 소음 평균 분석 표기
아래 예제는 소음의 **현재값(dBA)**, **최근 평균(dBA)**, **최댓값(dBA)** 을 계산하여 20×4 TextLCD에 실시간으로 표시합니다.  
표시 형식은 다음과 같습니다.

- 1행: 제목 (`Acoustic Monitor`)
- 2행: `Now:  xx.x dBA`
- 3행: `Avg:  xx.x dBA  Max: yy.y`
- 4행: 현재 소음값을 40~90 dBA 구간으로 정규화한 **바그래프(20칸)**

```python
from machine import I2C, Pin
from utime import sleep_ms, ticks_ms, ticks_diff

MIC_I2C_ADDR      = 0x28
MIC_REG_LO        = 0x30
MIC_REG_HI        = 0x31
MIC_TO_DBA_SCALE  = 0.1 
SAMPLE_INTERVAL_MS= 200 
AVG_WINDOW        = 100 
BAR_MIN_DBA       = 40.0
BAR_MAX_DBA       = 90.0
LCD_COLS, LCD_ROWS= 20, 4

lcd_i2c = I2C(0, sda=Pin(0),  scl=Pin(1),  freq=400000)
lcd     = TextLCD(lcd_i2c, addr=0x27, cols=LCD_COLS, rows=LCD_ROWS, backlight=True)

mic_i2c = I2C(1, sda=Pin(6),  scl=Pin(7),  freq=100000)

def read_dba_once():
    try:
        lo = mic_i2c.readfrom_mem(MIC_I2C_ADDR, MIC_REG_LO, 1)[0]
        hi = mic_i2c.readfrom_mem(MIC_I2C_ADDR, MIC_REG_HI, 1)[0]
        raw = (hi << 8) | lo
        return raw * MIC_TO_DBA_SCALE
    except Exception as e:
        return None

def clamp(x, lo, hi):
    return lo if x < lo else (hi if x > hi else x)

def make_bar(value, vmin=BAR_MIN_DBA, vmax=BAR_MAX_DBA, width=LCD_COLS):
    if vmax <= vmin:
        vmax = vmin + 1.0
    ratio = (value - vmin) / (vmax - vmin)
    ratio = clamp(ratio, 0.0, 1.0)
    filled = int(round(ratio * width))
    return "#" * filled + " " * (width - filled)

def main():
    lcd.clear()
    lcd.write_line(0, "Acoustic Monitor")
    lcd.write_line(1, "Now:  --.- dBA")
    lcd.write_line(2, "Avg:  --.- dBA  Max: --.-")
    lcd.write_line(3, " " * LCD_COLS)

    buf = []
    rolling_sum = 0.0
    dba_max = 0.0

    t_prev = ticks_ms()

    while True:
        while ticks_diff(ticks_ms(), t_prev) < SAMPLE_INTERVAL_MS:
            pass
        t_prev = ticks_ms()

        dba = read_dba_once()
        if dba is None:
            continue

        buf.append(dba)
        rolling_sum += dba
        if len(buf) > AVG_WINDOW:
            rolling_sum -= buf.pop(0)
        dba_avg = rolling_sum / len(buf)

        if dba > dba_max:
            dba_max = dba

        lcd.write_line(1, f"Now:  {dba:4.1f} dBA")
        lcd.write_line(2, f"Avg:  {dba_avg:4.1f} dBA  Max:{dba_max:4.1f}")
        lcd.write_line(3, make_bar(dba))

        sleep_ms(10)

if __name__ == "__main__":
    main()
```