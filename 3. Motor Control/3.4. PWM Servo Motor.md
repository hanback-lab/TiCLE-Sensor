# PWM Servo Motor 
서보모터(Servo Motor)는 로봇 팔, RC카, 카메라 짐벌 등 **정확한 각도 제어가 필요한 시스템**에 널리 사용되는 구동 장치입니다.  
본 장에서는 PWM(Pulse Width Modulation, 펄스 폭 변조)을 이용하여 서보모터를 제어하는 방법을 학습합니다.  

서보모터는 일반적으로 **DC 모터 + 기어박스 + 위치제어용 피드백 회로**로 구성되어 있으며,  
입력된 PWM 신호의 **펄스 폭(Pulse Width)** 에 따라 출력축의 회전 각도가 결정됩니다.

### 서보모터 신호 특성
| 항목 | 설명 |
|---|---|
| 동작 주파수 | 50 Hz (20 ms 주기) |
| 제어 신호 범위 | 약 0.5 ms ~ 2.5 ms |
| 각도 대응 | 0° ~ 180° |
| 전원 전압 | 4.8 V ~ 6 V |
| 제어 신호 전압 | 3.3 V (Pico와 직접 연결 가능) |

## PWM Servo Motor 연결 구성 

| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | Cable(RED) | 전원 |
| GND | Cable(Brown) | 접지 |
| GP15 | Cable(Yellow) | PWM Data |

![PWM Servo Motor Connection](res/pwm%20servo%20connection.png)

## PWM Servo Motor 제어 코드
PWM 신호를 변화하며 0~180 도 각도를 모두 움직이도록 제어해보겠습니다. 

```python
from machine import Pin, PWM
import time

servo = PWM(Pin(15))
servo.freq(50)

def set_angle(angle: float):
    min_duty = 1638
    max_duty = 8192
    duty = int(min_duty + (max_duty - min_duty) * angle / 180)
    servo.duty_u16(duty)
    print(f"Angle: {angle:3d}°, Duty: {duty}")

def main():
    try:
        while True:
            for angle in range(180):
                set_angle(angle)
                time.sleep(0.1)
    except KeyboardInterrupt:
        print('End')

if __name__ == "__main__":
    main()
```

> - PWM(Pin(15)) : GPIO 15 번 핀을 PWM 출력으로 설정합니다. RP2040 내부 PWM 하드웨어가 이 핀을 제어하게 됩니다.
> - freq(50) : 서보모터 표준 주파수 50 Hz(주기 20 ms) 로 설정합니다.
> - min_duty, max_duty : 0.5 ms (0°) ~ 2.5 ms (180°) 에 해당하는 듀티 값을 16비트 단위로 지정합니다.
> - duty_u16() : 계산된 듀티 비율을 PWM 하드웨어에 적용하여 펄스 폭을 변경합니다.
> - range(180) : 0°부터 179°까지 1°씩 증가시키며 서보를 부드럽게 회전시킵니다.

## 부드러운 가속 감속 회전 
서보모터가 목표 각도로 이동할 때 가속도 효과를 주어 자연스럽게 움직이도록 합니다.

```python
from machine import Pin, PWM
import time

servo = PWM(Pin(15))
servo.freq(50)

def set_angle(angle):
    min_duty = 1638
    max_duty = 8192
    duty = int(min_duty + (max_duty - min_duty) * angle / 180)
    servo.duty_u16(duty)

def move_smooth(start, end, delay=0.02):
    step = 1 if end > start else -1
    for angle in range(start, end + step, step):
        set_angle(angle)
        time.sleep(delay)

def main():
    while True:
        move_smooth(0, 180)
        time.sleep(1)
        move_smooth(180, 0)
        time.sleep(1)

if __name__ == "__main__":
    main()
```
> - input() 으로 사용자 각도 입력을 받아 서보 위치를 즉시 변경합니다.
> - 범위 검사 로 잘못된 입력에 대한 보호 기능을 추가하였습니다.

## 조이스틱 연동 제어 
조이스틱 모듈을 같이 활용하여 조이스틱 움직임에 따라 모터를 제어하도록 코드를 구현하면 다음과 같이 구현할 수 있습니다. 

```python
from machine import Pin, PWM, ADC
import time

adc = ADC(26)
servo = PWM(Pin(15))
servo.freq(50)

def set_angle(angle):
    min_duty = 1638
    max_duty = 8192
    duty = int(min_duty + (max_duty - min_duty) * angle / 180)
    servo.duty_u16(duty)

while True:
    value = adc.read_u16()
    angle = int(value * 180 / 65535)
    set_angle(angle)
    print(f"ADC={value}, Angle={angle}")
    time.sleep(0.05)
```

> - ADC(26) : GP26 핀에서 가변저항이나 조이스틱 전압을 읽습니다.
> - read_u16() 으로 0 ~ 65535 값을 얻고, 이를 0 ~ 180° 로 선형 변환합니다.
> - 실시간 아날로그 입력값 에 따라 서보 각도가 연속적으로 변합니다.