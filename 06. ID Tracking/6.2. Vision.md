# Vision Sensor
Vision Sensor는 카메라를 통해 이미지를 분석하고, QRCode나 BarCode와 같은 시각적 패턴을 인식하는 센서입니다. 이러한 센서는 물류, 공장 자동화, 스마트홈, 로봇비전 등에서 매우 폭넓게 활용됩니다.

Vision Sensor는 다음 단계를 통해 동작합니다:

- 1. 영상 촬영 (Capture) : 내장된 카메라 모듈이 실시간으로 이미지를 촬영합니다.
- 2. 영상 분석 (Image Processing) : 센서 내부 또는 외부 MCU가 이미지에서 QRCode나 BarCode와 같은 패턴을 탐지합니다.
- 3. 데이터 추출 (Decoding) : 탐지된 코드를 해석하여 내부에 저장된 문자, 숫자 등의 정보를 추출합니다.
- 4. 데이터 전송 (Communication) : 추출된 정보를 I²C, UART, 또는 USB 등의 인터페이스를 통해 MCU로 전달합니다.

## QRCODE 
QRCode는 일본의 DENSO WAVE사가 1994년에 개발한 2차원 코드입니다. 흑백 격자 무늬로 정보를 저장하며, 일반적인 BarCode보다 훨씬 많은 정보를 담을 수 있습니다.

| 구분 | 설명 |
|---|---|
| 구조 | 정사각형의 모듈(셀)로 구성됨 |
| 용량 | 최대 약 7,000자 이상의 문자 저장 가능 |
| 특징 | 손상 복원 기능 내장 (최대 30% 손상 복구 가능) |
| 용도 | 제품 인증, URL 연결, 결제, 출입 통제 등 |

QRCode는 2차원 평면에 정보를 배치하므로 가로, 세로 방향 모두에서 데이터 판독이 가능합니다.
또한 내부에 위치 검출 패턴(Finder Pattern) 이 있어 카메라 각도나 위치가 약간 틀어져도 인식이 가능합니다.

## BARCODE
BarCode는 가장 오래된 1차원 정보 인식 기술로, 굵기와 간격이 다른 선(Line) 의 패턴으로 숫자 또는 문자를 표현합니다.

| 구분 | 설명 |
|---|---|
| 구조 | 수평 막대와 간격으로 데이터 표현 |
| 용량 | 일반적으로 8~13자리 숫자(문자도 가능) |
| 종류 | EAN-13, CODE-39, CODE-128 등 다양한 표준 존재 |
| 용도 | 상품관리, 물류 추적, 재고관리 등 |

## Vision Sensor 연결 구성 
| Pin | 연결 대상 | 설명 |
|:---:|:---:|:---|
| 5V | +5V | 전원 |
| GND | GND | 접지 |
| GP0 | SDA | I2C 데이터 |
| GP1 | SCL | I2C 클록 |

## Vision Sensor Register 
Vision Sensor 는 I2C 로 통신하며 Slave Address 는 0x31 입니다. 인식된 QRCode 나 BarCode 의 정보는 미리 정의된 레지스터를 통해 읽을 수 있으며, 레지스터 정보는 다음과 같습니다. 

| 주소 | 이름 | 크기 | R/W | 설명 |
|:---:|:---|:-:|:-:|:---|
| 0x00 | `REG_STATUS` | 1B | R | 상태 플래그. 새 데이터, 오버런 등 비트 플래그 포함(아래 표 참고). |
| 0x01 | `REG_LEN` | 1B | R | 데이터 길이(바이트). `0`이면 유효 데이터 없음. |
| 0x02 | `REG_TYPE` | 1B | R | 코드 타입: `1=QRCODE`, `2=BARCODE` (필요 시 확장 가능). |
| 0x03 | `REG_SEQ` | 1B | R | 시퀀스 번호(0~255 순환). 데이터가 갱신될 때마다 +1. |
| 0x10~ | `REG_DATA_BASE` | N B | R | 텍스트 데이터(UTF-8). 길이는 `REG_LEN`과 동일. |

## Vision Sensor 제어 코드 
기본적으로 Vision Sensor 에 카메라에 QRCode 가 인식되면 Vision Sensor 에 장착되어 있는 좌측 LED 가 켜지고, BarCode 가 인식되면 우측 LED 가 켜지게 설정되어 있습니다. 이 LED 상태를 통해 인식된 코드의 정보를 판단할 수 있습니다. 이때 I2C 통신을 통해 인식된 코드의 종류와 내용정보를 직접 확인할 수 있습니다. 

```python
from machine import I2C, Pin
import utime

ADDR = 0x31
REG_STATUS      = 0x00
REG_LEN         = 0x01
REG_TYPE        = 0x02
REG_SEQ         = 0x03
REG_DATA_BASE   = 0x10

i2c = I2C(0, sda=Pin(0), scl=Pin(1), freq=100000)

def read_u8(reg):
    return i2c.readfrom_mem(ADDR, reg, 1)[0]

def read_block(reg, n):
    if n <= 0:
        return b""
    return bytes(i2c.readfrom_mem(ADDR, reg, n))

def read_message_once():
    length = read_u8(REG_LEN)
    typ    = read_u8(REG_TYPE)
    seq    = read_u8(REG_SEQ)

    data = b""
    if length > 0:
        data = read_block(REG_DATA_BASE, length)

    status = read_u8(REG_STATUS)
    return status, length, typ, seq, data

status, length, typ, seq, data = read_message_once()
print("STATUS=0x%02X  LEN=%d  TYPE=%d  SEQ=%d" % (status, length, typ, seq))
try:
    text = data.decode("utf-8")
except UnicodeError:
    text = data.decode("utf-8", "replace")
print("DATA:", text)
```

```sh
➜ replx vision_test.py
STATUS=0x07  LEN=38  TYPE=1  SEQ=25
DATA: QRCODE: https://m.site.naver.com/1PLDw
```